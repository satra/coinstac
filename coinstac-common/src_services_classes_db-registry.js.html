<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/services/classes/db-registry.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Base.html">Base</a><ul class='methods'><li data-type='method'><a href="Base.html#serialize">serialize</a></li><li data-type='method'><a href="Base.html#toJSON">toJSON</a></li></ul></li><li><a href="CommandComputation.html">CommandComputation</a><ul class='methods'><li data-type='method'><a href="CommandComputation.html#run">run</a></li><li data-type='method'><a href="CommandComputation.html#serialize">serialize</a></li><li data-type='method'><a href="CommandComputation.html#toJSON">toJSON</a></li></ul></li><li><a href="Computation.html">Computation</a><ul class='methods'><li data-type='method'><a href="Computation.html#.factory">factory</a></li><li data-type='method'><a href="Computation.html#run">run</a></li><li data-type='method'><a href="Computation.html#serialize">serialize</a></li><li data-type='method'><a href="Computation.html#toJSON">toJSON</a></li></ul></li><li><a href="ComputationRegistry.html">ComputationRegistry</a><ul class='methods'><li data-type='method'><a href="ComputationRegistry.html#.getNameAndVersion">getNameAndVersion</a></li><li data-type='method'><a href="ComputationRegistry.html#add">add</a></li><li data-type='method'><a href="ComputationRegistry.html#all">all</a></li><li data-type='method'><a href="ComputationRegistry.html#get">get</a></li><li data-type='method'><a href="ComputationRegistry.html#remove">remove</a></li></ul></li><li><a href="ComputationResult.html">ComputationResult</a><ul class='methods'><li data-type='method'><a href="ComputationResult.html#serialize">serialize</a></li><li data-type='method'><a href="ComputationResult.html#toJSON">toJSON</a></li></ul></li><li><a href="Consortium.html">Consortium</a><ul class='methods'><li data-type='method'><a href="Consortium.html#.compareUsernames">compareUsernames</a></li><li data-type='method'><a href="Consortium.html#hasMember">hasMember</a></li><li data-type='method'><a href="Consortium.html#isOwnedBy">isOwnedBy</a></li><li data-type='method'><a href="Consortium.html#serialize">serialize</a></li><li data-type='method'><a href="Consortium.html#toJSON">toJSON</a></li></ul></li><li><a href="DBListener.html">DBListener</a><ul class='methods'><li data-type='method'><a href="DBListener.html#destroy">destroy</a></li></ul></li><li><a href="DecentralizedComputation.html">DecentralizedComputation</a><ul class='methods'><li data-type='method'><a href="DecentralizedComputation.html#serialize">serialize</a></li><li data-type='method'><a href="DecentralizedComputation.html#toJSON">toJSON</a></li></ul></li><li><a href="File.html">File</a><ul class='methods'><li data-type='method'><a href="File.html#serialize">serialize</a></li><li data-type='method'><a href="File.html#toJSON">toJSON</a></li></ul></li><li><a href="JavascriptComputation.html">JavascriptComputation</a><ul class='methods'><li data-type='method'><a href="JavascriptComputation.html#run">run</a></li><li data-type='method'><a href="JavascriptComputation.html#serialize">serialize</a></li><li data-type='method'><a href="JavascriptComputation.html#toJSON">toJSON</a></li></ul></li><li><a href="LocalComputationResult.html">LocalComputationResult</a><ul class='methods'><li data-type='method'><a href="LocalComputationResult.html#serialize">serialize</a></li><li data-type='method'><a href="LocalComputationResult.html#toJSON">toJSON</a></li></ul></li><li><a href="LocalPipelineRunner.html">LocalPipelineRunner</a><ul class='methods'><li data-type='method'><a href="LocalPipelineRunner.html#findResultByRunId">findResultByRunId</a></li><li data-type='method'><a href="LocalPipelineRunner.html#getPreviousResultData">getPreviousResultData</a></li><li data-type='method'><a href="LocalPipelineRunner.html#getResultDocs">getResultDocs</a></li><li data-type='method'><a href="LocalPipelineRunner.html#run">run</a></li><li data-type='method'><a href="LocalPipelineRunner.html#saveResult">saveResult</a></li><li data-type='method'><a href="LocalPipelineRunner.html#serialize">serialize</a></li><li data-type='method'><a href="LocalPipelineRunner.html#toJSON">toJSON</a></li></ul></li><li><a href="LocalPipelineRunnerPool.html">LocalPipelineRunnerPool</a><ul class='methods'><li data-type='method'><a href="LocalPipelineRunnerPool.html#createNewRunner">createNewRunner</a></li><li data-type='method'><a href="LocalPipelineRunnerPool.html#destroy">destroy</a></li><li data-type='method'><a href="LocalPipelineRunnerPool.html#getDecentralizedComputation">getDecentralizedComputation</a></li><li data-type='method'><a href="LocalPipelineRunnerPool.html#getLatestResult">getLatestResult</a></li><li data-type='method'><a href="LocalPipelineRunnerPool.html#getLocalResult">getLocalResult</a></li><li data-type='method'><a href="LocalPipelineRunnerPool.html#getPipelinePlugins">getPipelinePlugins</a></li><li data-type='method'><a href="LocalPipelineRunnerPool.html#handleResultChange">handleResultChange</a></li><li data-type='method'><a href="LocalPipelineRunnerPool.html#init">init</a></li><li data-type='method'><a href="LocalPipelineRunnerPool.html#listenToConsortia">listenToConsortia</a></li><li data-type='method'><a href="LocalPipelineRunnerPool.html#serialize">serialize</a></li><li data-type='method'><a href="LocalPipelineRunnerPool.html#toJSON">toJSON</a></li><li data-type='method'><a href="LocalPipelineRunnerPool.html#triggerRunner">triggerRunner</a></li><li data-type='method'><a href="LocalPipelineRunnerPool.html#unlistenToConsortia">unlistenToConsortia</a></li><li data-type='method'><a href="LocalPipelineRunnerPool.html#upsertListener">upsertListener</a></li></ul></li><li><a href="Pipeline.html">Pipeline</a><ul class='methods'><li data-type='method'><a href="Pipeline.html#run">run</a></li><li data-type='method'><a href="Pipeline.html#serialize">serialize</a></li><li data-type='method'><a href="Pipeline.html#toJSON">toJSON</a></li></ul></li><li><a href="PipelineRunner.html">PipelineRunner</a><ul class='methods'><li data-type='method'><a href="PipelineRunner.html#findResultByRunId">findResultByRunId</a></li><li data-type='method'><a href="PipelineRunner.html#getPreviousResultData">getPreviousResultData</a></li><li data-type='method'><a href="PipelineRunner.html#getResultDocs">getResultDocs</a></li><li data-type='method'><a href="PipelineRunner.html#run">run</a></li><li data-type='method'><a href="PipelineRunner.html#saveResult">saveResult</a></li><li data-type='method'><a href="PipelineRunner.html#serialize">serialize</a></li><li data-type='method'><a href="PipelineRunner.html#toJSON">toJSON</a></li></ul></li><li><a href="PipelineRunnerPool.html">PipelineRunnerPool</a><ul class='methods'><li data-type='method'><a href="PipelineRunnerPool.html#createNewRunner">createNewRunner</a></li><li data-type='method'><a href="PipelineRunnerPool.html#destroy">destroy</a></li><li data-type='method'><a href="PipelineRunnerPool.html#getDecentralizedComputation">getDecentralizedComputation</a></li><li data-type='method'><a href="PipelineRunnerPool.html#getPipelinePlugins">getPipelinePlugins</a></li><li data-type='method'><a href="PipelineRunnerPool.html#handleResultChange">handleResultChange</a></li><li data-type='method'><a href="PipelineRunnerPool.html#init">init</a></li><li data-type='method'><a href="PipelineRunnerPool.html#listenToConsortia">listenToConsortia</a></li><li data-type='method'><a href="PipelineRunnerPool.html#serialize">serialize</a></li><li data-type='method'><a href="PipelineRunnerPool.html#toJSON">toJSON</a></li><li data-type='method'><a href="PipelineRunnerPool.html#triggerRunner">triggerRunner</a></li><li data-type='method'><a href="PipelineRunnerPool.html#unlistenToConsortia">unlistenToConsortia</a></li><li data-type='method'><a href="PipelineRunnerPool.html#upsertListener">upsertListener</a></li></ul></li><li><a href="PouchDocument.html">PouchDocument</a><ul class='methods'><li data-type='method'><a href="PouchDocument.html#serialize">serialize</a></li><li data-type='method'><a href="PouchDocument.html#toJSON">toJSON</a></li></ul></li><li><a href="Project.html">Project</a><ul class='methods'><li data-type='method'><a href="Project.html#serialize">serialize</a></li><li data-type='method'><a href="Project.html#toJSON">toJSON</a></li></ul></li><li><a href="RemoteComputationResult.html">RemoteComputationResult</a><ul class='methods'><li data-type='method'><a href="RemoteComputationResult.html#serialize">serialize</a></li><li data-type='method'><a href="RemoteComputationResult.html#toJSON">toJSON</a></li></ul></li><li><a href="RemotePipelineRunner.html">RemotePipelineRunner</a><ul class='methods'><li data-type='method'><a href="RemotePipelineRunner.html#findResultByRunId">findResultByRunId</a></li><li data-type='method'><a href="RemotePipelineRunner.html#getPreviousResultData">getPreviousResultData</a></li><li data-type='method'><a href="RemotePipelineRunner.html#getResultDocs">getResultDocs</a></li><li data-type='method'><a href="RemotePipelineRunner.html#getUserErrors">getUserErrors</a></li><li data-type='method'><a href="RemotePipelineRunner.html#run">run</a></li><li data-type='method'><a href="RemotePipelineRunner.html#saveResult">saveResult</a></li><li data-type='method'><a href="RemotePipelineRunner.html#serialize">serialize</a></li><li data-type='method'><a href="RemotePipelineRunner.html#toJSON">toJSON</a></li></ul></li><li><a href="RemotePipelineRunnerPool.html">RemotePipelineRunnerPool</a><ul class='methods'><li data-type='method'><a href="RemotePipelineRunnerPool.html#buildNewRemoteResult">buildNewRemoteResult</a></li><li data-type='method'><a href="RemotePipelineRunnerPool.html#createNewRunner">createNewRunner</a></li><li data-type='method'><a href="RemotePipelineRunnerPool.html#destroy">destroy</a></li><li data-type='method'><a href="RemotePipelineRunnerPool.html#getDecentralizedComputation">getDecentralizedComputation</a></li><li data-type='method'><a href="RemotePipelineRunnerPool.html#getLatestResult">getLatestResult</a></li><li data-type='method'><a href="RemotePipelineRunnerPool.html#getPipelinePlugins">getPipelinePlugins</a></li><li data-type='method'><a href="RemotePipelineRunnerPool.html#getRemoteResult">getRemoteResult</a></li><li data-type='method'><a href="RemotePipelineRunnerPool.html#handleResultChange">handleResultChange</a></li><li data-type='method'><a href="RemotePipelineRunnerPool.html#init">init</a></li><li data-type='method'><a href="RemotePipelineRunnerPool.html#listenToConsortia">listenToConsortia</a></li><li data-type='method'><a href="RemotePipelineRunnerPool.html#serialize">serialize</a></li><li data-type='method'><a href="RemotePipelineRunnerPool.html#toJSON">toJSON</a></li><li data-type='method'><a href="RemotePipelineRunnerPool.html#triggerRunner">triggerRunner</a></li><li data-type='method'><a href="RemotePipelineRunnerPool.html#unlistenToConsortia">unlistenToConsortia</a></li><li data-type='method'><a href="RemotePipelineRunnerPool.html#upsertListener">upsertListener</a></li></ul></li><li><a href="User.html">User</a><ul class='methods'><li data-type='method'><a href="User.html#serialize">serialize</a></li><li data-type='method'><a href="User.html#toJSON">toJSON</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-services_computation-registry-factory.html">services/computation-registry-factory</a><ul class='methods'><li data-type='method'><a href="module-services_computation-registry-factory.html#~computationRegistryFactory">computationRegistryFactory</a></li></ul></li><li><a href="module-services_db-registry.html">services/db-registry</a><ul class='methods'><li data-type='method'><a href="module-services_db-registry.html#~dbRegistryFactory">dbRegistryFactory</a></li></ul></li></ul><h3>Events</h3><ul><li><a href="DBListener.html#event:change">change</a></li><li><a href="DBListener.html#event:delete">delete</a></li><li><a href="LocalPipelineRunner.html#event:noop:noData">noop:noData</a></li><li><a href="LocalPipelineRunner.html#event:noop:noStateChange">noop:noStateChange</a></li><li><a href="LocalPipelineRunnerPool.html#event:computation:complete">computation:complete</a></li><li><a href="LocalPipelineRunnerPool.html#event:ready">ready</a></li><li><a href="LocalPipelineRunnerPool.html#event:listener:created">listener:created</a></li><li><a href="LocalPipelineRunnerPool.html#event:pipeline:inProgress">pipeline:inProgress</a></li><li><a href="LocalPipelineRunnerPool.html#event:queue:end">queue:end</a></li><li><a href="LocalPipelineRunnerPool.html#event:queue:start">queue:start</a></li><li><a href="LocalPipelineRunnerPool.html#event:run:end">run:end</a></li><li><a href="LocalPipelineRunnerPool.html#event:run:start">run:start</a></li><li><a href="Pipeline.html#event:save-request">save-request</a></li><li><a href="PipelineRunner.html#event:noop:noData">noop:noData</a></li><li><a href="PipelineRunner.html#event:noop:noStateChange">noop:noStateChange</a></li><li><a href="PipelineRunnerPool.html#event:computation:complete">computation:complete</a></li><li><a href="PipelineRunnerPool.html#event:ready">ready</a></li><li><a href="PipelineRunnerPool.html#event:listener:created">listener:created</a></li><li><a href="PipelineRunnerPool.html#event:pipeline:inProgress">pipeline:inProgress</a></li><li><a href="PipelineRunnerPool.html#event:queue:end">queue:end</a></li><li><a href="PipelineRunnerPool.html#event:queue:start">queue:start</a></li><li><a href="PipelineRunnerPool.html#event:run:end">run:end</a></li><li><a href="PipelineRunnerPool.html#event:run:start">run:start</a></li><li><a href="RemotePipelineRunner.html#event:noop:noData">noop:noData</a></li><li><a href="RemotePipelineRunner.html#event:noop:noStateChange">noop:noStateChange</a></li><li><a href="RemotePipelineRunnerPool.html#event:computation:complete">computation:complete</a></li><li><a href="RemotePipelineRunnerPool.html#event:ready">ready</a></li><li><a href="RemotePipelineRunnerPool.html#event:listener:created">listener:created</a></li><li><a href="RemotePipelineRunnerPool.html#event:pipeline:inProgress">pipeline:inProgress</a></li><li><a href="RemotePipelineRunnerPool.html#event:queue:end">queue:end</a></li><li><a href="RemotePipelineRunnerPool.html#event:queue:start">queue:start</a></li><li><a href="RemotePipelineRunnerPool.html#event:run:end">run:end</a></li><li><a href="RemotePipelineRunnerPool.html#event:run:start">run:start</a></li></ul><h3>Global</h3><ul><li><a href="global.html#cleanupTestDir">cleanupTestDir</a></li><li><a href="global.html#filterComputation">filterComputation</a></li><li><a href="global.html#getMockComputations">getMockComputations</a></li><li><a href="global.html#localResultOpts">localResultOpts</a></li><li><a href="global.html#MOCK_COMPUTATION_PATH">MOCK_COMPUTATION_PATH</a></li><li><a href="global.html#remoteResultOpts">remoteResultOpts</a></li><li><a href="global.html#seedInstanceComputations">seedInstanceComputations</a></li><li><a href="global.html#setupNetworkStubs">setupNetworkStubs</a></li><li><a href="global.html#setupTestDir">setupTestDir</a></li><li><a href="global.html#TEST_COMPUTATION_PATH">TEST_COMPUTATION_PATH</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">src/services/classes/db-registry.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

const os = require('os');
const LocalStorage = require('node-localstorage').LocalStorage;
const path = require('path');
global.LocalStorage = global.localStorage = new LocalStorage(path.join(os.tmpDir(), 'coinstac'));
const Pouchy = require('pouchy');
Pouchy.PouchDB.plugin(require('pouchdb-adapter-localstorage'));
// Pouchy.PouchDB.debug.enable('*');
const url = require('url');
const assign = require('lodash/assign');
const cloneDeep = require('lodash/cloneDeep');
const defaultsDeep = require('lodash/defaultsDeep');
const get = require('lodash/get');
const set = require('lodash/set');
const isString = require('lodash/isString');
const without = require('lodash/without');
const result = require('lodash/result');

/**
 * @private
 * @function arrHasEmbeddedMatch
 * @description tests if an array has a match embedded in its items
 * @param {array} arr
 * @param {string} str
 * @return {boolean}
 */
const arrHasEmbeddedMatch = (arr, str) => arr.some(toMatch => str.match(toMatch));

/**
 * @class DBRegistry
 * @private
 * @note use the db-registry module/service to obtain an env specific
 * db-registry instance.  this class is for _internal_ consumption only
 *
 * @example
 * const registry = DBRegistry({
 *    isRemote: true, // configure for compute/server instance
 *    dir: appDirectory,
 *    remoteStoresSyncIn: ['local-results'],
 *    remoteStoresSyncBoth: ['remote-results']
 * });
 *
 * @param {object} opts
 * @param {string} opts.path path to fs dir where dbs will be stored
 * @param {object} opts.remote Pouchy defaults applied to remote db instantiations
 * @param {object=} opts.local Pouchy defaults applied to local db instantiations
 * @param {array=} opts.localStores strings/regexes used to configure Pouch syncronization
 * @param {array=} opts.remoteStoresSyncBoth strings/regexes used to configure Pouch syncronization
 * @param {array=} opts.remoteStoresSyncIn strings/regexes used to configure Pouch syncronization
 * @param {array=} opts.remoteStoresSyncOut strings/regexes used to configure Pouch syncronization
 * @param {object=} opts.pouchConfig default PouchDB config applied to all pouchy instances
 * @param {boolean} opts.noURLPrefix option to disable prefixing remote db urls [default false]
 * @param {Function|object} [opts.ajax] object or function to be applied to each db request
 * @property {object} dbs
 * @property {array} dbs.all all db instances in the registry
 * @property {object} dbs.registry all db instances indexed by name/url
 * @property {array} names convenience prop to access list of current db names
 */
class DBRegistry {

  constructor(opts) {
    assign(this, opts);
    this.all = [];
    this.registry = {};
    if (!this.remote || !this.remote.db) {
      throw new ReferenceError([
        'DBRegistry `remote.db` as',
        '`url.format(opts.remote.db)`\'able configuration',
      ].join(' '));
    }
  }

  /**
   * gets an existing or new instance of a db
   * @param  {string} nameOrUrl name of db or url to remote db
   * @param {object=} opts passed directly to `.register`.  see `.register` for more
   * @return {Pouchy}
   */
  get(nameOrUrl, _opts) {
    const opts = Object.assign({}, _opts);
    /* istanbul ignore if */
    if (nameOrUrl.match(/^http/) || nameOrUrl.match(/^\//)) {
      opts.url = nameOrUrl;
    } else {
      opts.name = nameOrUrl;
    }

    if (this.registry[nameOrUrl]) {
      return this.registry[nameOrUrl];
    }

    return this.register(opts);
  }

  /**
   * @private
   */
  isBidirectionalSyncStore(connStr) {
    return (
      this.remoteStoresSyncBoth &amp;&amp;
      arrHasEmbeddedMatch(this.remoteStoresSyncBoth, connStr)
    );
  }

  /**
   * @private
   */
  isLocalStore(connStr) {
    return this.localStores &amp;&amp; arrHasEmbeddedMatch(this.localStores, connStr);
  }

  /**
   * @private
   */
  isSyncInStore(connStr) {
    return (
      this.remoteStoresSyncIn &amp;&amp;
      arrHasEmbeddedMatch(this.remoteStoresSyncIn, connStr)
    );
  }

  /**
   * @private
   */
  isSyncOutStore(connStr) {
    return (
      this.remoteStoresSyncOut &amp;&amp;
      arrHasEmbeddedMatch(this.remoteStoresSyncOut, connStr)
    );
  }

  /**
   * Register an app-level datastore.
   * @note remote url configurations stored on `this.remote` are not purely used
   * to generate Couch/Pouch request endpoints with the db name.  The pathname is
   * prefixed with an `'up/'` or `'down/' prior to `url.format(...)` such that
   * the coinstac-storage-proxy may intercept requests and perform auth/validation.
   * this prefixing occurs _only_ in `isLocal` mode.  `isRemote` mode implies
   * that the registry is working securely behind COINS infrastructure, and can
   * hit the Couch API directly, bypassing the proxy
   * @param  {object} opts      Required options for a Pouchy instance
   * @param  {string=} opts.name Store's registered name.
   *                             Should match a store array passed to constructor)
   * @param  {string=} opts.url  Store's URL
   * @returns {Pouchy}           Database instance
   */
  register(opts) {
    const conf = cloneDeep(opts);
    const rootRemoteDBPathname = get(this, 'remote.db.pathname') || '';
    const connStr = conf.name || conf.url;
    const noURLPrefix = this.isRemote || this.noURLPrefix;
    const _downPrefix = this.remoteDownPrefix || `${rootRemoteDBPathname}/down/`;
    const _upPrefix = this.remoteUpPrefix || `${rootRemoteDBPathname}/up/`;
    const remoteDownPrefix = noURLPrefix ? '' : _downPrefix;
    const remoteUpPrefix = noURLPrefix ? '' : _upPrefix;
    const syncDefaults = { live: true, retry: true, heartbeat: 5000 };
    conf.path = conf.path || this.path;
    conf.pouchConfig = conf.pouchConfig || {};

    // assert that db can register, and configure its domain
    if (this.isLocalStore(connStr)) {
      defaultsDeep(conf, this.local);
    } else if (this.isBidirectionalSyncStore(connStr)) {
      defaultsDeep(conf, this.remote);
      conf.replicate = { sync: defaultsDeep({}, this.replicationOpts, syncDefaults) };
      conf.url = conf.url || url.format(
        assign(
          {},
          this.remote.db,
          { pathname: path.join(rootRemoteDBPathname, conf.name) }
        ) // never up/down prefix dual-dir stores
      );
    } else if (this.isSyncInStore(connStr)) {
      defaultsDeep(conf, this.remote);
      conf.replicate = { in: defaultsDeep({}, this.replicationOpts, syncDefaults) };
      conf.url = conf.url || url.format(
        assign({}, this.remote.db, { pathname: remoteDownPrefix + conf.name })
      );
    } else if (this.isSyncOutStore(connStr)) {
      defaultsDeep(conf, this.remote);
      conf.replicate = { out: defaultsDeep({}, this.replicationOpts, syncDefaults) };
      conf.url = conf.url || url.format(
        assign({}, this.remote.db, { pathname: remoteUpPrefix + conf.name })
      );
    } else {
      /* istanbul ignore next */
      throw new ReferenceError(
        `database ${connStr} does not fit local or remote database variants`
      );
    }

    if (this.pouchConfig) {
      conf.pouchConfig = defaultsDeep(this.pouchConfig, conf.pouchConfig);
    }
    if (!conf.pouchConfig.adapter) {
      conf.pouchConfig.adapter = 'localstorage';
    }

    conf.pouchConfig.ajax = result(this, 'ajax');

    // convert string declared PouchDB adapter to adapter instance
    const requestedAdapter = get(conf, 'pouchConfig.db');
    /* istanbul ignore if */
    if (isString(requestedAdapter)) {
      set(conf, 'pouchConfig.db', require(requestedAdapter)); // eslint-disable-line
    }

    // build db and cache it
    const db = new Pouchy(conf);
    this.registry[conf.name || conf.url] = db;
    this.all.push(db);
    return db;
  }

  /**
   * Removes database from registry
   * @param  {Pouchy|string} db database or database name
   * @param  {function=} cb
   * @return {Promise}
   */
  unregister(db) {
    /* istanbul ignore if */
    if (typeof db === 'string') {
      db = this.all.find(pouchy => pouchy.name === db);
    }
    /* istanbul ignore if */
    if (!db) {
      throw new ReferenceError(`db "${name}" not found. unable to remove`);
    }
    /* istanbul ignore else */
    if (db.syncEmitter) { db.syncEmitter.cancel(); }
    return db.destroy()
    .then((rslt) => {
      this.all = without(this.all, db);
      delete this.registry[db.name];
      return rslt;
    });
  }

  destroy() {
    return Promise.all(this.all.map(this.unregister.bind(this)))
    .then((destroyed) => {
      const notDestroyed = destroyed.filter((confirmation) => !confirmation.ok);
      /* istanbul ignore if */
      if (notDestroyed.length) {
        throw new Error('unable to destroy all dbs');
      }
      return destroyed;
    });
  }
}

/**
 * @property {array} names returns an array of db names from the registry
 * @example `dbs.names;` ==> ['db1', 'db2']
 */
Object.defineProperty(DBRegistry.prototype, 'names', {
  get() {
    /* istanbul ignore next */
    return this.all.map((db) => db.name);
  },
  enumerable: true,
});

DBRegistry.Pouchy = Pouchy;

module.exports = DBRegistry;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
