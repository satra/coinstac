<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>index.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-simulator.html">simulator</a><ul class='methods'><li data-type='method'><a href="module-simulator.html#.run">run</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

/**
 * @module simulator
 */

const path = require('path');
const handleAsyncErrors = require('./handle-errors')(); // eslint-disable-line
const logger = require('./logger');
const bootComputeServers = require('./boot-compute-servers');
const bootClients = require('./boot-clients');
const bootDBServer = require('./boot-db-server');
const seedCentralDB = require('./seed-central-db');

const processes = {};

module.exports = {
  /**
   * @description boots the infrastructure required to run a simulation. this
   * includes a db server, computer server, and client processes for each client
   * in the provided simulation declaration
   * @param {string} declPath simulation declaration. @see {@link http://mrn-code.github.io/coinstac-simulator/index.html#how|declaration description}
   * @param {function}
   * @returns {Promise}
   */
  run(declPath) {
    // setup remote db service
    const cwd = process.cwd();
    process.chdir(path.resolve(__dirname, '..'));
    // ^because spawn-pouchdb-server makes naughty assumptions :/
    return bootDBServer.setup(declPath)
    .then((srv) => { processes.db = srv; })
    .then(() => logger.info('db server up'))
    .then(() => process.chdir(cwd))
    // seed central db with dummy conortium and computation data
    .then(() => seedCentralDB.seed(declPath))
    .then(() => logger.info('db seeded'))
    // boot our central compute server
    .then(() => bootComputeServers(declPath))
    .then((computeServers) => { processes.remote = computeServers[0]; })
    .then(() => logger.info('compute server up'))
    // boot user machines, and kickoff first computation
    .then(() => bootClients(declPath))
    .then((userProcesses) => { processes.local = userProcesses; })
    .then(() => logger.info('clients up'))
    .then(() => processes.local.forEach((proc) => proc.send({ kickoff: true })))
    .then(() => this.teardown());
  },

  /**
   * @private
   * @description tears down all processes. because `setup` both sets up and automatically
   * runs the simulation, teardown should be called immediately after setup
   * calls back.  this is generally unintuitive behavior.  please take note.
   * accepting PRs to break the run trigger out of the setup routing.
   * @returns {Promise}
   */
  teardown() {
    // teardown when computation cycle flagged as complete by
    // remote computation server (whom will exit on `complete`)
    return new Promise((resolve, reject) => {
      processes.remote.on('exit', () => {
        // kill all child processes cleanly after remote server has exited
        Promise.all(
          processes.local.map((proc, ndx) => { // eslint-disable-line
            return new Promise((res, rej) => {
              proc.on('message', (m) => {
                if (m.toredown) { return res(); }
                return rej(new Error('expected toredown message from child_process'));
              });
              proc.send({ teardown: true });
            });
          })
        )
        .then(() => bootDBServer.teardown())
        .then(() => resolve())
        .catch((err) => reject(err));
      });
    });
  },
};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
