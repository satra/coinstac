<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>db-server.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-simulator.html">simulator</a><ul class='methods'><li data-type='method'><a href="module-simulator.html#.run">run</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">db-server.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

/**
 * @private
 * @module db-server
 */

require('./handle-errors')();
const pdbs = require('spawn-pouchdb-server');
const cp = require('child_process');
const pdbsConfig = require('./.pouchdb-server-config');
const cloneDeep = require('lodash/cloneDeep');

const me = {};

/**
 * @function setup
 * @description boots a pouchdb-server, a dbRegistry instance, and
 * a computation registry instance.  these utilities are commonly
 * required for PipelineRunnerPool testing
 * @returns {Promise}
 */
const setup = () => { // eslint-disable-line
  return new Promise((res, rej) => {
    try { cp.execSync('pkill -f pouchdb-server'); } catch (err) {} // eslint-disable-line
    // @note ^^^ helpful to uncomment when tests are failing

    // spawn-pouchdb-server mutates user input >:(
    // https://github.com/hoodiehq/spawn-pouchdb-server/pull/33
    pdbs(cloneDeep(pdbsConfig), (err, srv) => {
      if (err) { return rej(err); }
      me.server = srv;
      return res(srv);
    });
  });
};

const teardown = () => { // eslint-disable-line
  return new Promise((res, rej) => {
    me.server.stop((err) => {
      if (err) { return rej(err); }
      return res();
    });
  });
};

process.on('message', (opts) => {
  if (opts.boot) {
    return setup(opts.boot)
    .then(() => process.send({ ready: true }));
  } else if (opts.teardown) {
    return teardown()
    .then(() => {
      process.send({ toredown: true });
      process.exit(0);
    });
  }
  throw new Error([
    'message from parent process has no matching command',
    JSON.stringify(opts),
  ].join(' '));
});
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
